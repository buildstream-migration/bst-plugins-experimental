image: registry.gitlab.com/buildstream/buildstream-docker-images/testsuite-fedora:30-master-86931906
# Testsuite image at a2ca12e76296f072fb98075bee257b2b6eb2523b (08/10/2019)

cache:
  paths:
    - cache/

stages:
  - test
  - docs
  - upload

before_script:
  # Diagnostics
  - mount
  - df -h

  - adduser -m buildstream
  - chown -R buildstream:buildstream .

#####################################################
#                    Test stage                     #
#####################################################

.test-template: &test-template
  stage: test
  variables: &test-variables
    PYTEST_ADDOPTS: "--color=yes"
  script:
    - export INTEGRATION_CACHE="$(pwd)/cache/integration-cache"
   
    - chown -R buildstream:buildstream .

    # Run the tests form the source distribution.
    # We run as a simple user to test for permission issues
    - su buildstream -c 'tox -- --integration'

test-fixed:
  <<: *test-template
  variables:
    <<: *test-variables
    TOXENV: "py37-bst-fixed"

test-master:
  image: registry.gitlab.com/buildstream/buildstream-docker-images/testsuite-fedora:31-latest
  <<: *test-template
  variables:
    <<: *test-variables
    TOXENV: "py37-bst-master"
  allow_failure: true

test-unix:
  stage: test
  variables:
    BST_FORCE_SANDBOX: "chroot"
    PYTEST_ADDOPTS: "--color=yes"
  script:

    # We remove the Bubblewrap and OSTree packages here so that we catch any
    # codepaths that try to use them. Removing OSTree causes fuse-libs to
    # disappear unless we mark it as user-installed.
    - dnf mark install fuse-libs systemd-udev
    - dnf erase -y bubblewrap ostree

    - export INTEGRATION_CACHE="$(pwd)/cache/integration-cache"

    # Since the unix platform is required to run as root, no user change required
    - tox -e py37-bst-fixed -- --integration

  artifacts:
    paths:
    - logs-unix/

lint:
  stage: test
  script:
  - tox -e lint

# Automatically build documentation, only for merges which land
# on master branch.
#
# Note: We still do not enforce a consistent installation of python2
#       or sphinx, as python2 will significantly grow the backing image.
#

#####################################################
#                  Docs stage                       #
#####################################################

pages:
  stage: docs
  script:
  - dnf install -y python2 make
  - pip3 install sphinx
  - pip3 install sphinx-click
  # Pin sphinx_rtd_theme because search functionality breaks
  # at the latest version
  - pip3 install sphinx_rtd_theme>=0.4.2
  - pip3 install --user .
  - make -C doc
  - mv doc/build/html public
  artifacts:
    paths:
    - public/
  only:
  - master


# Automatically upload to PyPI when a release is tagged.

#####################################################
#               Upload stage                        #
#####################################################

upload:
  stage: upload
  script:
  - python3 setup.py sdist
  - twine upload dist/*.tar.gz
  only:
  - /[0-9]+\.[0-9]+\.[0-9]+/
  except:
  - branches
